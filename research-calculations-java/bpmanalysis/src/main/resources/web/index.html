<!DOCTYPE html>
<html lang="en">
<head>
    <title>BPMVW</title>
    <link rel="stylesheet" href="css/vis-network.min.css" />
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/bmpdt.css" />
</head>
<body>
    <script src="js/vis.js"></script>
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script>
        $.getJSON("/models", function(data) {
            for (var i = 0; i < data.length; i++) {
                $("#processModelsList").append('<p>' +
                    '<div class="card" id="' + data[i].id + '">' +
                        '<div class="card-body">' +
                            '<a onclick="loadModel(\'' + data[i].id + '\')" href="#">' +
                                data[i].name + '</br>' + data[i].timeStamp + '</a>' +
                        '</div>' +
                    '</div>' +
                    '</p>');
            }
        });

        var activeModel = null;

        function loadModel(id) {
            $.getJSON("retrieve/" + id, function(data) {
                var container = document.getElementById('modelDescription');

                var graphData = {
                    nodes: data.graph.nodes,
                    edges: data.graph.edges
                };

                var options = {};

                new vis.Network(container, graphData, options);

                var modelInfo = $("#modelInfo");
                modelInfo.empty();

                modelInfo.append("<p><b>Business Process Model Name<b></p>");
                modelInfo.append("<p>" + data.name + "</p>");

                modelInfo.append("<p><b>Business Process Model Notation<b></p>");
                modelInfo.append("<p>" + data.notation + "</p>");

                modelInfo.append("<p><b>Business Process Model Detail Level<b></p>");
                modelInfo.append("<p>" + data.level + "</p>");

                modelInfo.append("<p><b>Business Process Model Text Description<b></p>");
                modelInfo.append("<p>" + data.description + "</p>");

                modelInfo.append('<p>' +
                    '<button id="analyzeModel" onclick="analyzeModel(\'' + data.id + '\')" ' +
                        'class="btn btn-primary">Analyze Model</button></p>');

                modelInfo.append('<p><a href="add.html?id=' + id + '">Update model</a> ' +
                    '<a href="remove/' + data.id + '" onclick="return confirm(\'Delete this model?\')">' +
                    'Delete model</a></p>');

                $("#modelAnalysis").empty();

                if (activeModel != null) {
                    $('#' + activeModel).css('background-color', 'white');
                }

                $('#' + data.id).css('background-color', 'lightGrey');
                activeModel = data.id;
            });
        }

        function analyzeModel(id) {
            $.getJSON("analyze/" + id, function(data) {
                var modelAnalysis = $("#modelAnalysis");
                modelAnalysis.empty();

                modelAnalysis.append('<div id="rulesViolations"></div>');

                var isModelValid = true;

                if (data.nodesChanges[0] > 0) {
                    modelAnalysis.append("<p><b>Size:</b> " + data.size + ' <span style="color:green">(+' +
                        data.nodesChanges[0] + ")</span></p>");
                    isModelValid = false;
                } else if (data.nodesChanges[0] < 0) {
                    modelAnalysis.append("<p><b>Size:</b> " + data.size + ' <span style="color:red">(' +
                        data.nodesChanges[0] + ")</span></p>");
                    isModelValid = false;
                } else {
                    modelAnalysis.append("<p><b>Size:</b> " + data.size + "</p>");
                }

                if (data.nodesChanges[4] > 0) {
                    modelAnalysis.append("<p><b>Functions:</b> " + data.functions + ' <span style="color:green">(+' +
                        data.nodesChanges[4] + ")</span></p>");
                    isModelValid = false;
                } else if (data.nodesChanges[4] < 0) {
                    modelAnalysis.append("<p><b>Functions:</b> " + data.functions + ' <span style="color:red">(' +
                        data.nodesChanges[4] + ")</span></p>");
                    isModelValid = false;
                } else {
                    modelAnalysis.append("<p><b>Functions:</b> " + data.functions + "</p>");
                }

                if (data.connectorsBalance > 0) {
                    modelAnalysis.append("<p><b>Connectors Balance:</b> " + data.connectorsBalance +
                        ' <span style="color:red">(invalid)</span></p>');
                    isModelValid = false;
                } else {
                    modelAnalysis.append("<p><b>Connectors Balance:</b> " + data.connectorsBalance + "</p>");
                }

                if (data.connectorsBalance > 0) {
                    var connectorsChanges = '<table class="table table-sm"><thead><tr>' +
                            '<th scope="col">Element</th>' +
                            '<th scope="col">Degree</th>' +
                        '</tr></thead><tbody>';

                    var connectorsCount = 0;

                    Object.keys(data.connectorsChanges).forEach(function(key, index) {
                        if (data.connectorsChanges[key] != 0) {
                            connectorsChanges += '<tr><th scope="row">' +
                                '<a data-toggle="modal" data-target="#exampleModalCenter" href="#" ' +
                                    'onclick="searchForElement(\'' + id + '\', \'' + key + '\')">' + key + '</a></th>' +
                                '<td>' + data.connectorsChanges[key] + '</td></tr>';

                            connectorsCount++;
                        }
                    });

                    if (connectorsCount > 0) {
                        modelAnalysis.append(connectorsChanges + '</tbody></table>');
                    } else {
                        modelAnalysis.append('<div class="alert alert-info" role="alert">' +
                            'Recommendations will be provided after nodes issues are fixed' +
                        '</div>');
                    }
                }

                if (data.functionsBalance > 0) {
                    modelAnalysis.append("<p><b>Functions Balance:</b> " + data.functionsBalance +
                        ' <span style="color:red">(invalid)</span></p>');
                    isModelValid = false;
                } else {
                    modelAnalysis.append("<p><b>Functions Balance:</b> " + data.functionsBalance + "</p>");
                }

                if (data.functionsBalance > 0) {
                    var functionsChanges = '<table class="table table-sm"><thead><tr>' +
                            '<th scope="col">Element</th>' +
                            '<th scope="col">Inputs</th>' +
                            '<th scope="col">Controls</th>' +
                            '<th scope="col">Outputs</th>' +
                            '<th scope="col">Mechanisms</th>' +
                        '</tr></thead><tbody>';

                    var functionsCount = 0;

                    Object.keys(data.functionsChanges).forEach(function(key, index) {
                        if (data.functionsChanges[key][0] != 0 || data.functionsChanges[key][1] != 0 ||
                            data.functionsChanges[key][2] != 0 || data.functionsChanges[key][3] != 0) {
                            functionsChanges += '<tr><th scope="row">' +
                                    '<a data-toggle="modal" data-target="#exampleModalCenter" href="#" ' +
                                        'onclick="searchForElement(\'' + id + '\', \'' + key + '\')">' + key + '</a></th>' +
                                    '<td>' + data.functionsChanges[key][0] + '</td>' +
                                    '<td>' + data.functionsChanges[key][1] + '</td>' +
                                    '<td>' + data.functionsChanges[key][2] + '</td>' +
                                    '<td>' + data.functionsChanges[key][3] + '</td>' +
                                '</tr>';

                            functionsCount++;
                        }
                    });

                    if (functionsCount > 0) {
                        modelAnalysis.append(functionsChanges + '</tbody></table>');
                    } else {
                        modelAnalysis.append('<div class="alert alert-info" role="alert">' +
                            'Recommendations will be provided after nodes issues are fixed' +
                        '</div>');
                    }
                }

                if (data.nodesChanges[1] > 0) {
                    modelAnalysis.append("<p><b>Start Events:</b> " + data.startEvents + ' <span style="color:green">(+' +
                        data.nodesChanges[1] + ")</span></p>");
                    isModelValid = false;
                } else if (data.nodesChanges[1] < 0) {
                    modelAnalysis.append("<p><b>Start Events:</b> " + data.startEvents + ' <span style="color:red">(' +
                        data.nodesChanges[1] + ")</span></p>");
                    isModelValid = false;
                } else {
                    modelAnalysis.append("<p><b>Start Events:</b> " + data.startEvents + "</p>");
                }

                if (data.nodesChanges[2] > 0) {
                    modelAnalysis.append("<p><b>End Events:</b> " + data.endEvents + ' <span style="color:green">(+' +
                        data.nodesChanges[2] + ")</span></p>");
                    isModelValid = false;
                } else if (data.nodesChanges[2] < 0) {
                    modelAnalysis.append("<p><b>End Events:</b> " + data.endEvents + ' <span style="color:red">(' +
                        data.nodesChanges[2] + ")</span></p>");
                    isModelValid = false;
                } else {
                    modelAnalysis.append("<p><b>End Events:</b> " + data.endEvents + "</p>");
                }

                if (data.mismatch > 0) {
                    modelAnalysis.append("<p><b>Connectors Mismatch:</b> " + data.mismatch +
                        ' <span style="color:red">(invalid)</span></p>');
                    isModelValid = false;
                } else {
                    modelAnalysis.append("<p><b>Connectors Mismatch:</b> " + data.mismatch + "</p>");
                }

                if (data.mismatch > 0) {
                    var mismatchChanges = '<table class="table table-sm"><thead><tr>' +
                            '<th scope="col">Type</th>' +
                            '<th scope="col">Split</th>' +
                            '<th scope="col">Join</th>' +
                        '</tr></thead><tbody>';

                    mismatchCount = 0;

                    Object.keys(data.routingChanges).forEach(function(key, index) {
                        if (data.routingChanges[key][0] != 0 || data.routingChanges[key][1] != 0) {
                            mismatchChanges += '<tr><th scope="row">' + key + '</th>' +
                                    '<td>' + data.routingChanges[key][0] + '</td>' +
                                    '<td>' + data.routingChanges[key][1] + '</td>' +
                                '</tr>';

                            mismatchCount++;
                        }
                    });

                    if (mismatchCount > 0) {
                        modelAnalysis.append(mismatchChanges + '</tbody></table>');
                    } else {
                        modelAnalysis.append('<div class="alert alert-info" role="alert">' +
                            'Recommendations will be provided after nodes issues are fixed' +
                        '</div>');
                    }
                }

                if (data.nodesChanges[3] > 0) {
                    modelAnalysis.append("<p><b>OR Connectors:</b> " + data.orConnectors + ' <span style="color:green">(+' +
                        data.nodesChanges[3] + ")</span></p>");
                    isModelValid = false;
                } else if (data.nodesChanges[3] < 0) {
                    modelAnalysis.append("<p><b>OR Connectors:</b> " + data.orConnectors + ' <span style="color:red">(' +
                        data.nodesChanges[3] + ")</span></p>");
                    isModelValid = false;
                } else {
                    modelAnalysis.append("<p><b>OR Connectors:</b> " + data.orConnectors + "</p>");
                }

                modelAnalysis.append("<p><b>Quality:</b> " + data.quality + "</p>");
                modelAnalysis.append("<p><b>Error probability:</b> " + data.hasErrors + "</p>");

                if (!isModelValid) {
                    $('#rulesViolations').append('<div class="alert alert-danger" role="danger">' +
                        'This model might contain errors!</div>');
                }

                modelAnalysis.append('<div id="similarModels"></div>');

                var duplicatesCounter = 0;

                if (data.similarModels != null) {
                    Object.keys(data.similarModels).forEach(function(key, index) {
                        modelAnalysis.append('<p>' +
                            '<a href="#' + key + '" onclick="loadModel(\'' + key + '\')">' + data.similarModels[key] + '</a>' +
                            '</p>');
                        duplicatesCounter++;
                    });
                }

                if (duplicatesCounter > 0) {
                    $('#similarModels').append('<div class="alert alert-warning" role="alert">' +
                        'There are similar models found!</div>');
                }
            });
        }

        function searchForElement(modelId, elementId) {
            $('#elementSearchResult').empty();
            $('#searchElementName').empty();

            $.getJSON("search/" + modelId + "/" + escape(elementId), function(data) {
                $('#searchElementName').append(elementId);

                var container = document.getElementById('elementSearchResult');

                var graphData = {
                    nodes: data.graph.nodes,
                    edges: data.graph.edges
                };

                var options = {};

                new vis.Network(container, graphData, options);
            });
        }
    </script>
    <h3>
        <kbd>Business Process Models Viewer</kbd>
        <small><a href="./add.html">Add Model</a></small>
    </h3>
    <div class="row">
        <div class="col-md-4">
            <p>
                <b>Stored Business Process Models</b>
            </p>
            <div id="processModelsList" style="height: 600px; overflow-y: scroll;"></div>
        </div>
        <div class="col-md-8">
            <p>
                <div id="modelDescription"></div>
            </p>
            <p>
                <div id="modelInfo"></div>
            </p>
            <p>
                <div id="modelAnalysis"></div>
            </p>
            <!-- Modal -->
            <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLongTitle">Search element '<span id="searchElementName"></span>'</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div id="elementSearchResult" style="height: 300px;"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>