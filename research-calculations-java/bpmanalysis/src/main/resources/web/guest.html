<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Process Models</title>
    <link rel="stylesheet" href="css/vis-network.min.css" />
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/bmpdt.css" />
</head>
<body>
    <script src="js/vis.js"></script>
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script>
        $.getJSON("/models", function(data) {
            for (var i = 0; i < data.length; i++) {
                $("#processModelsList").append('<p>' +
                    '<div class="card" id="' + data[i].id + '">' +
                        '<div class="card-body">' +
                            '<a onclick="loadModel(\'' + data[i].id + '\')" href="javascript:void(0)">' +
                                data[i].name + '</br>' + data[i].timeStamp + '</a>' +
                        '</div>' +
                    '</div>' +
                    '</p>');
            }

            var get = function(name) {
                if (name = (new RegExp('[?&]'+encodeURIComponent(name)+'=([^&]*)')).exec(location.search))
                    return decodeURIComponent(name[1]);
            }

            var modelId = get('id');

            if (typeof modelId !== "undefined") {
                loadModel(modelId);
            }
        });

        var activeModel = null;

        function loadModel(id) {
            $.getJSON("retrieve/" + id, function(data) {
                var container = document.getElementById('modelDescription');

                var graphData = {
                    nodes: data.graph.nodes,
                    edges: data.graph.edges
                };

                var options = {};

                new vis.Network(container, graphData, options);

                var imageContainer = document.getElementById('modelImage');
                imageContainer.src = 'images/' + data.fileName + '.svg';

                $('#descriptionLink').show();
                $('#modelLink').show();

                $('#modelDescription').hide();
                $('#modelImage').show();

                var modelInfo = $("#modelInfo");
                modelInfo.empty();

                modelInfo.append("<p><b>Business Process Model Name<b></p>");
                modelInfo.append("<p>" + data.name + "</p>");

                modelInfo.append("<p><b>Business Process Model Notation<b></p>");
                modelInfo.append("<p>" + data.notation + "</p>");

                modelInfo.append("<p><b>Business Process Model Detail Level<b></p>");
                modelInfo.append("<p>" + data.level + "</p>");

                modelInfo.append("<p><b>Business Process Model Text Description<b></p>");
                modelInfo.append("<p>" + data.description + "</p>");

                modelInfo.append("<p><b>Business Process Model File<b></p>");
                modelInfo.append("<p>" + data.fileName + "</p>");

                if (activeModel != null) {
                    $('#' + activeModel).css('background-color', 'white');
                }

                $('#' + data.id).css('background-color', 'lightGrey');
                activeModel = data.id;

                var updateURLParameter = function(url, param, paramVal){
                    var newAdditionalURL = "";
                    var tempArray = url.split("?");
                    var baseURL = tempArray[0];
                    var additionalURL = tempArray[1];
                    var temp = "";
                    if (additionalURL) {
                        tempArray = additionalURL.split("&");
                        for (var i=0; i<tempArray.length; i++){
                            if(tempArray[i].split('=')[0] != param){
                                newAdditionalURL += temp + tempArray[i];
                                temp = "&";
                            }
                        }
                    }

                    var rows_txt = temp + "" + param + "=" + paramVal;
                    return baseURL + "?" + newAdditionalURL + rows_txt;
                }

                window.history.replaceState('', '', updateURLParameter(window.location.href, "id", data.id));
            });
        }
    </script>
    <h3>
        <small>guest</small> |
        <!--<small><a href="./add.html">Add Model</a></small>-->
        <small><a href="./login.html">Login</a></small>
    </h3>
    <div class="row">
        <div class="col-md-4">
            <p>
                <b>Stored Business Process Models</b>
            </p>
            <div id="processModelsList" style="height: 600px; overflow-y: scroll;"></div>
        </div>
        <div class="col-md-8">
            <p>
                <a href="javascript:void(0);" onclick="displayModel();" id="modelLink" class="btn btn-secondary btn-sm">Model</a>
                <a href="javascript:void(0);" onclick="displayGraph();" id="descriptionLink" class="btn btn-secondary btn-sm">Graph</a>
                <script type="text/javascript">
                    $('#descriptionLink').hide();
                    $('#modelLink').hide();

                    function displayModel() {
                        $('#modelDescription').hide();
                        $('#modelImage').show();
                    }

                    function displayGraph() {
                        $('#modelDescription').show();
                        $('#modelImage').hide();
                    }
                </script>
            </p>
            <p>
                <div id="modelDescription"></div>
            </p>
            <p>
                <iframe id="modelImage"></iframe>
            </p>
            <script type="text/javascript">
                $('#modelDescription').hide();
                $('#modelImage').hide();
            </script>
            <p>
                <div id="modelInfo"></div>
            </p>
        </div>
    </div>
</body>
</html>