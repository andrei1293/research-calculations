<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BPMAI Tool</title>
    <link rel="stylesheet" href="css/bootstrap.min.css" />
</head>
<body style="margin: 2%;">
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/bpmn-viewer.development.js"></script>
    <script>
        $.getJSON("/bpmai/api/models", function(data) {
            for (var i = 0; i < data.length; i++) {
                $("#processModelsList").append('<p>' +
                    '<div class="card" id="' + data[i].id + '">' +
                        '<div class="card-body">' +
                            '<a onclick="loadModel(\'' + data[i].id + '\')" href="javascript:void(0)">' +
                                data[i].name + '</br>' + data[i].timeStamp + '</a>' +
                        '</div>' +
                    '</div>' +
                    '</p>');
            }

            var get = function(name) {
                if (name = (new RegExp('[?&]'+encodeURIComponent(name)+'=([^&]*)')).exec(location.search))
                    return decodeURIComponent(name[1]);
            };

            var modelId = get('id');

            if (typeof modelId !== "undefined") {
                loadModel(modelId);
            }
        });

        var activeModel = null;

        function loadModel(id) {
            $.getJSON("/bpmai/api/model/" + id, function(data) {
                var modelInfo = $("#modelInfo");
                modelInfo.empty();

                modelInfo.append("<p><b>Business Process Model Name<b></p>");
                modelInfo.append("<p>" + data.name + "</p>");

                modelInfo.append("<p><b>Business Process Model Notation<b></p>");
                modelInfo.append("<p>" + data.notation + "</p>");

                modelInfo.append("<p><b>Business Process Model File<b></p>");
                modelInfo.append("<p><a href='/models/" + data.fileName + "'>" + data.fileName + "</a></p>");

                $("#modelAnalysis").empty();

                if (activeModel != null) {
                    $('#' + activeModel).css('background-color', 'white');
                }

                $('#' + data.id).css('background-color', 'lightGrey');
                activeModel = data.id;

                var updateURLParameter = function(url, param, paramVal){
                    var newAdditionalURL = "";
                    var tempArray = url.split("?");
                    var baseURL = tempArray[0];
                    var additionalURL = tempArray[1];
                    var temp = "";

                    if (additionalURL) {
                        tempArray = additionalURL.split("&");

                        for (var i = 0; i < tempArray.length; i++) {

                            if (tempArray[i].split('=')[0] != param) {
                                newAdditionalURL += temp + tempArray[i];
                                temp = "&";
                            }
                        }
                    }

                    var rows_txt = temp + "" + param + "=" + paramVal;
                    return baseURL + "?" + newAdditionalURL + rows_txt;
                }

                window.history.replaceState('', '', updateURLParameter(window.location.href, "id", data.id));

                analyzeModel(id);

                drawModel(data);
            });
        }

        function drawModel(data) {
            $('#canvas').empty();

            var xhr = new XMLHttpRequest();

            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    var viewer = new BpmnJS({ container: '#canvas' });
                    
                    viewer.importXML(xhr.response, function(err) {
                        var canvas = viewer.get('canvas');
                        canvas.zoom('fit-viewport');
                    });
                }
            };

            xhr.open('GET', '/models/' + data.fileName, true);
            xhr.send(null);
        }

        function analyzeModel(id) {
            $.getJSON("/bpmai/api/model/" + id, function(data) {
                var modelAnalysis = $("#modelAnalysis");

                modelAnalysis.empty();

                var isModelValid = true;

                modelAnalysis.append("<p><b>Size:</b> " + data.size + "</p>");
                modelAnalysis.append("<p><b>Functions:</b> " + data.functions + "</p>");
                modelAnalysis.append("<p><b>Connectors Balance:</b> " + data.connectorsBalance + "</p>");
                modelAnalysis.append("<p><b>Functions Balance:</b> " + data.functionsBalance + "</p>");
                modelAnalysis.append("<p><b>Start Events:</b> " + data.startEvents + "</p>");
                modelAnalysis.append("<p><b>End Events:</b> " + data.endEvents + "</p>");
                modelAnalysis.append("<p><b>Connectors Mismatch:</b> " + data.mismatch + "</p>");
                modelAnalysis.append("<p><b>OR Connectors:</b> " + data.orConnectors + "</p>");

                modelAnalysis.append("<p><b>Quality:</b> " + data.quality + "</p>");

                if (data.quality < 1.0) {
                    isModelValid = false;
                }

                if (!isModelValid) {
                    modelAnalysis.append('<div id="rulesViolations"></div>');
                    $('#rulesViolations').append('<div class="alert alert-danger" role="danger">' +
                        'This model might contain errors!</div>');
                    
                    for (var x in data.recommendations) {
                        modelAnalysis.append('<div class="alert alert-info" role="info">' + data.recommendations[x] + '</div>');
                    }
                } else {
                    modelAnalysis.append('<div id="similarModels"></div>');

                    var duplicatesCounter = 0;

                    if (data.similarModels != null) {
                        Object.keys(data.similarModels).forEach(function(key, index) {
                            modelAnalysis.append('<div class="alert alert-info" role="info">' +
                                '<a target="_blank" href="?id=' + key + '">' + data.similarModels[key] + '</a>' +
                                '</div>');
                            duplicatesCounter++;
                        });
                    }

                    if (duplicatesCounter > 0) {
                        $('#similarModels').append('<div class="alert alert-warning" role="alert">' +
                            'There are similar models found!</div>');
                    }
                }
            });
        }
    </script>
    <div class="row">
        <div class="col-md-4">
            <p>
                <a href="bpmai.html"><h3>BPMAI Tool</h3></a>
            </p>
            <div id="processModelsList" style="height: 600px; overflow-y: scroll;"></div>
        </div>
        <div class="col-md-8">
            <p>
                <div id="modelInfo"></div>
            </p>
            <p>
                <div id="modelAnalysis"></div>
            </p>
            <div id="canvas" style="height: 100%;"></div>
        </div>
    </div>
</body>
</html>